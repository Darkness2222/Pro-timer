(()=>{
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const pad=n=>String(n).padStart(2,â€˜0â€™);
const LS={
theme:â€˜synccue.themeâ€™,
mH:â€˜synccue.main.hoursâ€™,
mHs:â€˜synccue.main.hundredthsâ€™,
mC:â€˜synccue.main.colorâ€™,
pH:â€˜synccue.pomo.hoursâ€™,
pHs:â€˜synccue.pomo.hundredthsâ€™,
pC:â€˜synccue.pomo.colorâ€™,
sH:â€˜synccue.sw.hoursâ€™,
sHs:â€˜synccue.sw.hundredthsâ€™,
sC:â€˜synccue.sw.colorâ€™,
proTimers:â€˜synccue.pro.timersâ€™,
proMessages:â€˜synccue.pro.messagesâ€™
};

// Supabase Configuration - Add your credentials here
const SUPABASE_URL = â€˜â€™; // Your Supabase URL
const SUPABASE_ANON_KEY = â€˜â€™; // Your Supabase anon key

const screens=[â€˜mainTimerâ€™,â€˜pomodoroâ€™,â€˜stopwatchâ€™,â€˜proTimerâ€™];
let si=0;

function show(i){
si=(i+screens.length)%screens.length;
screens.forEach((id,idx)=>{
const el = $(â€™#â€™+id);
if(el) el.classList.toggle(â€˜activeâ€™, idx===si);
});
syncTabs();

if(screens[si] === â€˜proTimerâ€™) {
initProTimer();
}
}

function syncTabs(){
$$(â€™.tabâ€™).forEach(b=>{
const a=b.dataset.tab===screens[si];
b.classList.toggle(â€˜activeâ€™,a);
b.setAttribute(â€˜aria-selectedâ€™,a?â€˜trueâ€™:â€˜falseâ€™);
});
}

$$(â€™.tabâ€™).forEach(btn=>btn.addEventListener(â€˜clickâ€™,()=>{
const id=btn.dataset.tab;
const idx=screens.indexOf(id);
if(idx>=0) show(idx);
}));

function applyTheme(v){
document.body.classList.toggle(â€˜darkâ€™, v===â€˜darkâ€™);
localStorage.setItem(LS.theme,v);
const toggle = $(â€™#themeToggleâ€™);
if(toggle) toggle.textContent = v===â€˜darkâ€™ ? â€˜â˜€ï¸â€™ : â€˜ğŸŒ™â€™;
}

const themeToggle = $(â€™#themeToggleâ€™);
if(themeToggle) {
themeToggle.addEventListener(â€˜clickâ€™, ()=>
applyTheme(document.body.classList.contains(â€˜darkâ€™)?â€˜lightâ€™:â€˜darkâ€™)
);
}

applyTheme(localStorage.getItem(LS.theme)||â€˜darkâ€™);
syncTabs();

function exportListToCSV(el, filename, header=â€˜timestamp,eventâ€™){
if(!el) return;
const rows=[header];
el.querySelectorAll(â€˜liâ€™).forEach(li=>{
const t=li.textContent.split(â€™ â€” â€˜);
if(t.length>=2) rows.push(`"${t[0].replace(/"/g,'""')}","${t.slice(1).join(' â€” ').replace(/"/g,'""')}"`);
else rows.push(`,"${li.textContent.replace(/"/g,'""')}"`);
});
const blob=new Blob([rows.join(â€™\nâ€™)],{type:â€˜text/csv;charset=utf-8;â€™});
const a=document.createElement(â€˜aâ€™);
a.href=URL.createObjectURL(blob);
a.download=filename;
a.click();
setTimeout(()=>URL.revokeObjectURL(a.href),500);
}

function fmtTime(ms, showH, showHund){
const hundredths = Math.floor((ms%1000)/10);
let totalSec = Math.floor(ms/1000);
const s = totalSec % 60;
totalSec = Math.floor(totalSec/60);
const m = totalSec % 60;
const h = Math.floor(totalSec/60);
const base = (showH || h>0) ? `${pad(h)}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
return showHund ? `${base}.${pad(hundredths)}` : base;
}

/* â€“â€“â€“â€“â€“ Fullscreen overlay â€“â€“â€“â€“â€“ */
const fs=$(â€™#fsâ€™), fsDigits=$(â€™#fsDigitsâ€™), fsBar=$(â€™#fsBarâ€™), fsElapsed=$(â€™#fsElapsedâ€™), fsBarWrap=$(â€™#fsBarWrapâ€™), fsStatus=$(â€™#fsStatusâ€™);
let fsMode=null;

function setFsFont(text){
if(!fsDigits) return;
const len=text.length;
let size=â€˜20vwâ€™;
if(len>=12) size=â€˜12vwâ€™;
else if(len>=10) size=â€˜15vwâ€™;
else if(len>=9) size=â€˜18vwâ€™;
fsDigits.style.fontSize=size;
}

function openFS(mode, text, ratio, paused, color, showBar){
if(!fs || !fsDigits) return;
fsMode=mode;
fsDigits.textContent=text;
fsDigits.style.color=color||â€™â€™;
setFsFont(text);
if(fsBarWrap) fsBarWrap.style.display=showBar?â€˜blockâ€™:â€˜noneâ€™;
const r=Math.max(0,Math.min(1,ratio||0));
if(fsBar) fsBar.style.transform=`scaleX(${r})`;
if(fsElapsed) fsElapsed.style.width=`${(1-r)*100}%`;
if(fsStatus) fsStatus.style.display = paused?â€˜blockâ€™:â€˜noneâ€™;
fs.classList.remove(â€˜hiddenâ€™);
}

function closeFS(){
fsMode=null;
if(fs) fs.classList.add(â€˜hiddenâ€™);
}

const fsExit = $(â€™#fsExitâ€™);
if(fsExit) fsExit.addEventListener(â€˜clickâ€™, closeFS);

window.addEventListener(â€˜resizeâ€™,()=>{
if(!fsMode || !fsDigits) return;
setFsFont(fsDigits.textContent);
});

/* â€“â€“â€“â€“â€“ Main Timer â€“â€“â€“â€“â€“ */
let mainDur=300000, mainRemain=300000, mainRunning=false, mainTick=null, mainStep=1000;
const mainDigits=$(â€™#mainTimeâ€™), mainBar=$(â€™#mainBarâ€™), mainElapsed=$(â€™#mainElapsedâ€™), mainLog=$(â€™#mainLogâ€™);
const optHours=$(â€™#optHoursâ€™), optHund=$(â€™#optHundredthsâ€™), digitColor=$(â€™#digitColorâ€™);
const mtModal=$(â€™#mtSettingsâ€™);

const mainSettings = $(â€™#mainSettingsâ€™);
if(mainSettings) mainSettings.addEventListener(â€˜clickâ€™, ()=>mtModal?.classList.remove(â€˜hiddenâ€™));
const mtClose = $(â€™#mtCloseâ€™);
if(mtClose) mtClose.addEventListener(â€˜clickâ€™, ()=>mtModal?.classList.add(â€˜hiddenâ€™));
const mtCancel = $(â€™#mtCancelâ€™);
if(mtCancel) mtCancel.addEventListener(â€˜clickâ€™, ()=>mtModal?.classList.add(â€˜hiddenâ€™));
const mainToggleLog = $(â€™#mainToggleLogâ€™);
if(mainToggleLog) mainToggleLog.addEventListener(â€˜clickâ€™, ()=>$(â€™#mainLogCardâ€™)?.classList.toggle(â€˜hiddenâ€™));

if(optHours) optHours.checked=(localStorage.getItem(LS.mH)||â€˜falseâ€™)===â€˜trueâ€™;
if(optHund) optHund.checked =(localStorage.getItem(LS.mHs)||â€˜falseâ€™)===â€˜trueâ€™;
if(digitColor) {
digitColor.value = localStorage.getItem(LS.mC) || â€˜#e53935â€™;
if(mainDigits) mainDigits.style.color = digitColor.value;
}

if(optHours) optHours.onchange=()=>{ localStorage.setItem(LS.mH,optHours.checked?â€˜trueâ€™:â€˜falseâ€™); drawMain(); };
if(optHund) optHund.onchange =()=>{ localStorage.setItem(LS.mHs,optHund.checked?â€˜trueâ€™:â€˜falseâ€™); setMainCadence(); drawMain(); };
if(digitColor) digitColor.oninput=e=>{ localStorage.setItem(LS.mC,e.target.value); if(mainDigits) mainDigits.style.color=e.target.value; if(fsMode===â€˜mainâ€™ && fsDigits) fsDigits.style.color=e.target.value; };

const mainInput=$(â€™#mainInputâ€™);

function fmtMain(){ return fmtTime(mainRemain, optHours?.checked, optHund?.checked); }
function setMainCadence(){ const step=optHund?.checked?10:1000; if(step!==mainStep){ mainStep=step; if(mainRunning){ clearInterval(mainTick); mainTick=setInterval(tickMain, mainStep); } } }
function drawMain(){
if(!mainDigits) return;
mainDigits.textContent=fmtMain();
const r=(mainDur?mainRemain/mainDur:0);
const rr=Math.max(0,Math.min(1,r));
if(mainBar) mainBar.style.transform=`scaleX(${rr})`;
if(mainElapsed) mainElapsed.style.width=`${(1-rr)*100}%`;
updateFS(â€˜mainâ€™, r, !mainRunning && mainRemain>0 && mainRemain<mainDur, mainDigits.textContent, digitColor?.value, true);
}
function tickMain(){ mainRemain=Math.max(0,mainRemain-mainStep); drawMain(); if(mainRemain<=0){ mainPause(); log(mainLog,â€˜Finishedâ€™); } }
function mainStart(){ if(mainRunning) return; if(mainRemain<=0){ if(mainDur<=0) return; mainRemain=mainDur; } setMainCadence(); mainRunning=true; mainTick=setInterval(tickMain, mainStep); log(mainLog,`Started (${fmtMain()})`); }
function mainPause(){ if(!mainRunning) return; mainRunning=false; clearInterval(mainTick); drawMain(); log(mainLog,`Paused at ${fmtMain()}`); }
function mainStop(){ mainRunning=false; clearInterval(mainTick); mainRemain=0; drawMain(); log(mainLog,â€˜Stoppedâ€™); }
function mainReset(){ mainRunning=false; clearInterval(mainTick); mainRemain=mainDur; drawMain(); log(mainLog,â€˜Resetâ€™); }

function setMainFromInput(){
if(!mainInput) return;
const v=mainInput.value.trim();
const mm=/^(\d+):(\d{2})$/.exec(v);
if(!mm){ alert(â€˜Use mm:ss formatâ€™); return; }
const m=+mm[1], s=+mm[2];
mainDur=(m*60+s)*1000;
mainRemain=mainDur;
drawMain();
log(mainLog,`Set to ${fmtMain()}`);
}

function log(el,text){
if(!el) return;
const li=document.createElement(â€˜liâ€™);
li.textContent=new Date().toLocaleTimeString()+â€™ â€” â€™+text;
el.prepend(li);
}

// Main Timer Event Listeners
const mainStart_btn = $(â€™#mainStartâ€™);
if(mainStart_btn) mainStart_btn.addEventListener(â€˜clickâ€™, mainStart);
const mainPause_btn = $(â€™#mainPauseâ€™);
if(mainPause_btn) mainPause_btn.addEventListener(â€˜clickâ€™, mainPause);
const mainStop_btn = $(â€™#mainStopâ€™);
if(mainStop_btn) mainStop_btn.addEventListener(â€˜clickâ€™, mainStop);
const mainReset_btn = $(â€™#mainResetâ€™);
if(mainReset_btn) mainReset_btn.addEventListener(â€˜clickâ€™, mainReset);
const mainSet_btn = $(â€™#mainSetâ€™);
if(mainSet_btn) mainSet_btn.addEventListener(â€˜clickâ€™, setMainFromInput);
const mainClearLog_btn = $(â€™#mainClearLogâ€™);
if(mainClearLog_btn) mainClearLog_btn.addEventListener(â€˜clickâ€™, ()=>mainLog && (mainLog.innerHTML=â€™â€™));
const mainExportCSV_btn = $(â€™#mainExportCSVâ€™);
if(mainExportCSV_btn) mainExportCSV_btn.addEventListener(â€˜clickâ€™, ()=>exportListToCSV(mainLog,â€˜main_timer_log.csvâ€™));
const mtExport_btn = $(â€™#mtExportâ€™);
if(mtExport_btn) mtExport_btn.addEventListener(â€˜clickâ€™, ()=>exportListToCSV(mainLog,â€˜main_timer_log.csvâ€™));

$$(â€™[data-preset]â€™).forEach(b=>b.addEventListener(â€˜clickâ€™, ()=>{
const s=parseInt(b.dataset.preset,10);
mainDur=s*1000;
mainRemain=mainDur;
drawMain();
log(mainLog,`Preset ${b.textContent}`);
}));

$$(â€™[data-adjust]â€™).forEach(b=>b.addEventListener(â€˜clickâ€™, ()=>{
const d=parseInt(b.dataset.adjust,10)*1000;
mainRemain=Math.max(0,mainRemain+d);
if(mainRemain>mainDur) mainDur=mainRemain;
drawMain();
log(mainLog,`Adjust ${b.textContent} â†’ ${fmtMain()}`);
}));

const mainFullscreen_btn = $(â€™#mainFullscreenâ€™);
if(mainFullscreen_btn) {
mainFullscreen_btn.addEventListener(â€˜clickâ€™, ()=>
openFS(â€˜mainâ€™, mainDigits?.textContent||â€˜00:00â€™, (mainDur?mainRemain/mainDur:0), !mainRunning && mainRemain>0 && mainRemain<mainDur, digitColor?.value, true)
);
}

/* â€“â€“â€“â€“â€“ Pro Timer (Simplified for now) â€“â€“â€“â€“â€“ */
let proTimers = [], activeProTimer = null, proCurrentTime = 0, proIsRunning = false, proMessages = [], proTick = null;
let proView = â€˜adminâ€™, showQR = false;

function loadProTimers() {
try {
const saved = localStorage.getItem(LS.proTimers);
proTimers = saved ? JSON.parse(saved) : [];
} catch(e) {
proTimers = [];
}
}

function saveProTimers() {
localStorage.setItem(LS.proTimers, JSON.stringify(proTimers));
}

function loadProMessages() {
try {
const saved = localStorage.getItem(LS.proMessages);
proMessages = saved ? JSON.parse(saved) : [];
} catch(e) {
proMessages = [];
}
}

function saveProMessages() {
localStorage.setItem(LS.proMessages, JSON.stringify(proMessages));
}

function initProTimer() {
loadProTimers();
loadProMessages();

// Check URL parameters for presenter mode
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get(â€˜viewâ€™) === â€˜presenterâ€™) {
const timerId = urlParams.get(â€˜timerâ€™);
if(timerId && timerId !== â€˜demoâ€™) {
const timer = proTimers.find(t => t.id === timerId);
if(timer) {
activeProTimer = timer;
proCurrentTime = timer.duration;
loadProMessages();
}
}
proView = â€˜presenterâ€™;
}

renderProTimer();
}

function renderProTimer() {
const container = $(â€™#proTimerâ€™);
if(!container) return;

container.innerHTML = `<div class="pro-admin" style="padding: 2rem; text-align: center;"> <h2 style="font-size: 2rem; margin-bottom: 2rem;">ğŸ¯ Pro Timer</h2> <p style="font-size: 1.25rem; color: #9ca3af; margin-bottom: 2rem;">Professional presentation timers with admin control</p> <div style="background: #374151; padding: 2rem; border-radius: 12px; margin: 2rem auto; max-width: 600px;"> <div style="margin-bottom: 1.5rem;"> <div style="font-size: 3rem; font-family: 'Courier New', monospace; color: #e53935; margin-bottom: 1rem;">05:00</div> <div style="width: 100%; height: 8px; background: #4b5563; border-radius: 4px; margin-bottom: 1rem;"> <div style="width: 100%; height: 100%; background: linear-gradient(to right, #10b981, #f59e0b, #ef4444); border-radius: 4px;"></div> </div> <p style="color: #d1d5db; margin-bottom: 1.5rem;">Demo Timer - Full features coming soon!</p> </div> <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;"> <button onclick="alert('Pro Timer features coming soon!')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">â–¶ï¸ Start Demo</button> <button onclick="alert('Create timer feature coming soon!')" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">+ Create Timer</button> <button onclick="alert('Share feature coming soon!')" style="padding: 0.75rem 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”— Share</button> </div> </div> <div style="margin-top: 2rem; padding: 1.5rem; background: #1f2937; border-radius: 8px; border-left: 4px solid #60a5fa;"> <h3 style="color: #60a5fa; margin-bottom: 1rem;">Coming Soon Features:</h3> <ul style="text-align: left; color: #d1d5db; line-height: 1.6;"> <li>âœ¨ Admin control panel</li> <li>ğŸ“± QR code sharing</li> <li>ğŸ’¬ Real-time messaging</li> <li>â˜ï¸ Cloud synchronization</li> <li>ğŸ‘¥ Multi-device support</li> </ul> </div> </div>`;
}

/* â€“â€“â€“â€“â€“ FS update while open â€“â€“â€“â€“â€“ */
function updateFS(mode, ratio, paused, text, color, showBar){
if(fsMode!==mode) return;
if(!fsDigits) return;
fsDigits.textContent=text;
fsDigits.style.color=color||â€™â€™;
setFsFont(text);
if(fsBarWrap) fsBarWrap.style.display=showBar?â€˜blockâ€™:â€˜noneâ€™;
if(showBar && fsBar && fsElapsed){
const r=Math.max(0,Math.min(1,ratio||0));
fsBar.style.transform=`scaleX(${r})`;
fsElapsed.style.width=`${(1-r)*100}%`;
}
if(fsStatus) fsStatus.style.display=paused?â€˜blockâ€™:â€˜noneâ€™;
}

if(fsDigits) {
fsDigits.addEventListener(â€˜clickâ€™, ()=>{
if(fsMode===â€˜mainâ€™){ if(mainRunning) mainPause(); else mainStart(); }
});
}

/* â€“â€“â€“â€“â€“ Init â€“â€“â€“â€“â€“ */
function init(){
// Check for presenter mode on page load
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get(â€˜viewâ€™) === â€˜presenterâ€™) {
show(screens.indexOf(â€˜proTimerâ€™));
} else {
show(0);
}

if(mainDigits) drawMain();
}

init();

// Enhanced resize handler
window.addEventListener(â€˜resizeâ€™, ()=>{
try{if(mainDigits) drawMain();}catch(e){}
});

})();
